#!/usr/bin/env bash

# Symmetric Proxy Bridge - Updated for Litebike Universal Protocol Detection
# Key changes: Use port 8888 universal proxy, better TERMUX_HOST handling, SSH localhost forwarding

set -euo pipefail

# Colors
readonly RED='\033[0;31m'
readonly GREEN='\033[0;32m'
readonly BLUE='\033[0;34m'
readonly YELLOW='\033[1;33m'
readonly NC='\033[0m'

# Configuration
readonly SCRIPT_VERSION="2.1.0-litebike"
readonly UNIVERSAL_PORT=8888        # Litebike universal protocol detection port
readonly SSH_PORT="${TERMUX_PORT:-8022}"
readonly SSH_USER="${TERMUX_USER:-u0_a471}"
readonly PRIMARY_INTERFACE="swlan0"
readonly LITEBIKE_BINARY="$HOME/litebike/target/release/litebike"

# Auto-detect TERMUX_HOST if not set
if [ -z "${TERMUX_HOST:-}" ]; then
    case "$(uname)" in
        "Darwin")
            TERMUX_HOST=$(route get default 2>/dev/null | grep gateway | awk '{print $2}' || echo "192.168.1.1")
            ;;
        *)
            TERMUX_HOST=$(ip route get 8.8.8.8 2>/dev/null | grep via | awk '{print $3}' || echo "192.168.1.1")
            ;;
    esac
fi

log_info() { echo -e "[$(date '+%H:%M:%S')] ${GREEN}INFO${NC} $*" >&2; }
log_warn() { echo -e "[$(date '+%H:%M:%S')] ${YELLOW}WARN${NC} $*" >&2; }
log_error() { echo -e "[$(date '+%H:%M:%S')] ${RED}ERROR${NC} $*" >&2; }

get_local_ip() {
    case "$(uname)" in
        "Darwin")
            ifconfig en0 2>/dev/null | grep 'inet ' | awk '{print $2}' || echo "127.0.0.1"
            ;;
        *)
            ifconfig 2>/dev/null | grep -A2 swlan0 | grep 'inet ' | awk '{print $2}' || echo "127.0.0.1"
            ;;
    esac
}

# Start litebike server
start_server() {
    local mode="${1:-default}"
    
    log_info "Starting litebike server..."
    
    # Build if needed
    if [ ! -x "$LITEBIKE_BINARY" ]; then
        log_info "Building litebike..."
        if [ -d "$HOME/litebike" ]; then
            cd "$HOME/litebike"
            cargo build --release || exit 1
        else
            log_error "litebike source not found at $HOME/litebike"
            exit 1
        fi
    fi
    
    # Kill existing and free port
    pkill -f litebike 2>/dev/null || true
    pkill -f ":$UNIVERSAL_PORT" 2>/dev/null || true
    sleep 2
    
    # Check if port is still in use (Termux-compatible)
    if netstat -tulpn 2>/dev/null | grep ":$UNIVERSAL_PORT " >/dev/null 2>&1; then
        log_warn "Port $UNIVERSAL_PORT still in use, finding alternative..."
        UNIVERSAL_PORT=8889
        log_info "Using alternative port: $UNIVERSAL_PORT"
    fi
    
    # Get local IP for binding
    local bind_ip=$(get_local_ip)
    
    # Start litebike on universal port  
    log_info "Starting litebike on universal port $UNIVERSAL_PORT"
    log_info "Binding to: $bind_ip:$UNIVERSAL_PORT"
    cd "$HOME/litebike"
    
    # Try to start with proper error handling
    local log_file="$HOME/litebike.log"
    export BIND_IP="$bind_ip"
    "$LITEBIKE_BINARY" >"$log_file" 2>&1 &
    local litebike_pid=$!
    
    sleep 3
    
    # Check if litebike started successfully
    if kill -0 $litebike_pid 2>/dev/null; then
        log_info "✅ Litebike started on $bind_ip:$UNIVERSAL_PORT (PID: $litebike_pid)"
    else
        log_error "Failed to start litebike - check $log_file for details"
        [ -f "$log_file" ] && tail -20 "$log_file"
        return 1
    fi
    log_info "Supports: HTTP, HTTPS, SOCKS5, TLS, DoH, PAC/WPAD, Bonjour, UPnP"
    
    # Print PAC and auto-discovery URLs
    echo
    log_info "${GREEN}Auto-Discovery URLs:${NC}"
    echo "  PAC URL:        http://$bind_ip:$UNIVERSAL_PORT/proxy.pac"
    echo "  WPAD URL:       http://$bind_ip:$UNIVERSAL_PORT/wpad.dat"
    echo "  Config URL:     http://$bind_ip:$UNIVERSAL_PORT/config"
    echo
    log_info "${GREEN}Bonjour/mDNS:${NC}"
    echo "  Service Name:   litebike-proxy._http._tcp.local"
    echo "  Service Type:   _http._tcp"
    echo
    log_info "${GREEN}Manual Configuration:${NC}"
    echo "  HTTP Proxy:     $bind_ip:$UNIVERSAL_PORT"
    echo "  SOCKS5 Proxy:   $bind_ip:$UNIVERSAL_PORT"
    echo "  SSH Forward:    ssh -L 8888:${bind_ip}:8888 ${SSH_USER}@${bind_ip} -p ${SSH_PORT}"
}

# SSH localhost forwarding helper
ssh_forward() {
    local remote_host="${1:-$TERMUX_HOST}"
    local local_port="${2:-$UNIVERSAL_PORT}"
    local remote_port="${3:-$UNIVERSAL_PORT}"
    
    log_info "Setting up SSH localhost forwarding..."
    log_info "Local: localhost:$local_port -> Remote: $remote_host:$remote_port"
    
    # Kill existing SSH forwards
    pkill -f "ssh.*$local_port:.*:$remote_port" 2>/dev/null || true
    
    # Start SSH tunnel
    ssh -N -L "$local_port:$remote_host:$remote_port" "$SSH_USER@$remote_host" -p "$SSH_PORT" &
    local ssh_pid=$!
    
    sleep 2
    
    if kill -0 $ssh_pid 2>/dev/null; then
        log_info "✅ SSH tunnel established (PID: $ssh_pid)"
        log_info "Access proxy via: localhost:$local_port"
        
        echo
        echo "curl --proxy http://localhost:${local_port} http://httpbin.org/ip"
    else
        log_error "SSH tunnel failed to start"
        return 1
    fi
}

# Start client configuration
start_client() {
    local target="${1:-$TERMUX_HOST}"
    
    # Resolve "auto" to actual TERMUX_HOST
    if [[ "$target" == "auto" ]]; then
        target="$TERMUX_HOST"
    fi
    
    log_info "Configuring client for: $target"
    
    # Test if proxy is responding
    if ! curl -s --max-time 3 --proxy "http://$target:$UNIVERSAL_PORT" "http://httpbin.org/ip" >/dev/null 2>&1; then
        log_warn "Proxy not responding, trying to start via SSH..."
        ssh -p "$SSH_PORT" "$SSH_USER@$target" "bash proxy-bridge server" &
        sleep 3
    fi
    
    # Configure system proxy (macOS)
    if [[ "$(uname)" == "Darwin" ]]; then
        local wifi_service=$(networksetup -listallnetworkservices | grep -E "Wi-Fi|AirPort" | head -1 || echo "Wi-Fi")
        
        log_info "Configuring system proxy for $wifi_service"
        log_info "Setting proxy to: $target:$UNIVERSAL_PORT"
        
        networksetup -setwebproxy "$wifi_service" "$target" "$UNIVERSAL_PORT"
        networksetup -setsecurewebproxy "$wifi_service" "$target" "$UNIVERSAL_PORT"
        networksetup -setsocksfirewallproxy "$wifi_service" "$target" "$UNIVERSAL_PORT"
        networksetup -setwebproxystate "$wifi_service" on
        networksetup -setsecurewebproxystate "$wifi_service" on
        networksetup -setsocksfirewallproxystate "$wifi_service" on
        
        log_info "✅ System proxy configured to $target:$UNIVERSAL_PORT"
    fi
    
    # Configure git
    git config --global http.proxy "http://$target:$UNIVERSAL_PORT"
    git config --global https.proxy "http://$target:$UNIVERSAL_PORT"
    log_info "✅ Git proxy configured"

    log_warn "Remember to check ~/.config/pip/pip.conf for potential proxy conflicts if experiencing issues with pip."
    
    # Test connection
    test_connection "$target"
}

# Test proxy connection
test_connection() {
    local host="${1:-$TERMUX_HOST}"
    
    log_info "Testing connection to $host:$UNIVERSAL_PORT..."
    
    # Test HTTP
    if curl -s --max-time 10 --proxy "http://$host:$UNIVERSAL_PORT" "http://httpbin.org/ip" >/dev/null; then
        log_info "✅ HTTP proxy working"
    else
        log_error "❌ HTTP proxy failed"
    fi
    
    # Test SOCKS5  
    if curl -s --max-time 10 --socks5 "$host:$UNIVERSAL_PORT" "http://httpbin.org/ip" >/dev/null; then
        log_info "✅ SOCKS5 proxy working"
    else
        log_error "❌ SOCKS5 proxy failed"
    fi
    
    # Show current IP
    echo -e "${BLUE}Current external IP:${NC}"
    curl -s --max-time 5 --proxy "http://$host:$UNIVERSAL_PORT" ifconfig.me/ip || echo "Unable to determine"
}

# Stop all services
stop_all() {
    log_info "Stopping all proxy services..."
    
    # Kill litebike
    pkill -f litebike 2>/dev/null && log_info "✓ litebike stopped" || log_info "✓ No litebike running"
    
    # Kill SSH forwards
    pkill -f "ssh.*$UNIVERSAL_PORT:" 2>/dev/null && log_info "✓ SSH forwards stopped" || log_info "✓ No SSH forwards"
    
    # Clear system proxy (macOS)
    if [[ "$(uname)" == "Darwin" ]]; then
        local wifi_service=$(networksetup -listallnetworkservices | grep -E "Wi-Fi|AirPort" | head -1 || echo "Wi-Fi")
        networksetup -setwebproxystate "$wifi_service" off 2>/dev/null || true
        networksetup -setsecurewebproxystate "$wifi_service" off 2>/dev/null || true
        networksetup -setsocksfirewallproxystate "$wifi_service" off 2>/dev/null || true
        log_info "✓ System proxy cleared"
    fi
    
    # Clear git proxy
    git config --global --unset http.proxy 2>/dev/null || true
    git config --global --unset https.proxy 2>/dev/null || true
    log_info "✓ Git proxy cleared"

    log_warn "Remember to check ~/.config/pip/pip.conf for any lingering proxy configurations."
    
    log_info "✅ All services stopped"
}

# Show status
show_status() {
    echo -e "${YELLOW}System Status:${NC}"
    echo -e "Platform: $(uname)"
    echo -e "Local IP: $(get_local_ip)"
    echo -e "TERMUX_HOST: $TERMUX_HOST"
    echo -e "Universal Port: $UNIVERSAL_PORT"
    echo
    
    # Check processes
    if pgrep -f litebike >/dev/null 2>&1; then
        echo -e "${GREEN}✓ litebike server running${NC}"
        echo
        echo -e "${YELLOW}Auto-Discovery URLs:${NC}"
        echo "  PAC URL:        http://$(get_local_ip):$UNIVERSAL_PORT/proxy.pac"
        echo "  WPAD URL:       http://$(get_local_ip):$UNIVERSAL_PORT/wpad.dat"
        echo "  Config URL:     http://$(get_local_ip):$UNIVERSAL_PORT/config"
    else
        echo -e "${BLUE}✗ litebike server not running${NC}"
    fi
    
    if pgrep -f "ssh.*$UNIVERSAL_PORT:" >/dev/null 2>&1; then
        echo -e "${GREEN}✓ SSH forward active${NC}"
    else
        echo -e "${BLUE}✗ No SSH forwards${NC}"
    fi
    echo
    echo "ssh -L 8888:${TERMUX_HOST}:8888 ${SSH_USER}@${TERMUX_HOST} -p ${SSH_PORT}"
}

# Start lightweight bridge on remote B: bind nc on 8888 forwarding to A:8888
remote_nc_bridge() {
    local remote_host="${1:-$TERMUX_HOST}"
    local upstream_host="${2:-}"
    local upstream_port="${3:-$UNIVERSAL_PORT}"

    if [[ -z "$upstream_host" ]]; then
        log_error "Usage: $0 bridge-to-a <A_HOST> [REMOTE_HOST]"
        log_error "Example: $0 bridge-to-a my.mac.host"
        return 1
    fi

    log_info "Requesting lightweight nc bridge on ${remote_host}:$UNIVERSAL_PORT -> ${upstream_host}:${upstream_port}"

    # Best-effort script to run on remote: prefer busybox nc, fallback to nc, set to keep-listening
    # Kill existing listeners on 8888
    local remote_cmd='
        set -eu
        P='"'"$UNIVERSAL_PORT"'"'
        UHOST='"'"$upstream_host"'"'
        UPORT='"'"$upstream_port"'"'
        # kill previous
        pkill -f "nc -lk .*:$P" 2>/dev/null || true
        pkill -f "nc -l -k .*:$P" 2>/dev/null || true
        # choose nc
        if command -v busybox >/dev/null 2>&1; then
            NC="busybox nc"
        elif command -v nc >/dev/null 2>&1; then
            NC="nc"
        else
            echo "no netcat found" >&2
            exit 1
        fi
        # run bridge: listener on :P piping to upstream
        # different nc variants use -lk vs -l -k flags; try both
        ($NC -lk -p "$P" -e "/system/bin/sh -c \"$NC $UHOST $UPORT\"") >/dev/null 2>&1 & disown || \
        ($NC -l -k -p "$P" -e "/system/bin/sh -c \"$NC $UHOST $UPORT\"") >/dev/null 2>&1 & disown || \
        # fallback using FIFO
        (rm -f /data/data/$P.fifo 2>/dev/null || true; mkfifo /data/data/$P.fifo; \
         while true; do $NC -l -p "$P" < /data/data/$P.fifo | $NC "$UHOST" "$UPORT" > /data/data/$P.fifo; done) >/dev/null 2>&1 & disown
        echo "nc bridge started on :$P -> $UHOST:$UPORT"
    '

    ssh -p "$SSH_PORT" "$SSH_USER@$remote_host" "bash -lc 'UNIVERSAL_PORT=$UNIVERSAL_PORT $remote_cmd'"
}

show_help() {
    echo -e "${BLUE}╔══════════════════════════════════╗${NC}"
    echo -e "${BLUE}║    PROXY BRIDGE - LITEBIKE       ║${NC}"
    echo -e "${BLUE}║   Universal Port 8888 Proxy     ║${NC}"
    echo -e "${BLUE}╚══════════════════════════════════╝${NC}"
    echo
    echo -e "${YELLOW}Usage:${NC}"
    echo "  $0 server [mode]           - Start litebike server"
    echo "  $0 client [host]           - Configure client (auto-starts server via SSH)"
    echo "  $0 forward [host] [port]   - SSH localhost forward to proxy"
    echo "  $0 test [host]             - Test proxy connection"
    echo "  $0 status                  - Show current status"
    echo "  $0 stop                    - Stop all services"
    echo
    echo -e "${YELLOW}Examples:${NC}"
    echo "  # On Termux (Server):"
    echo "  $0 server                  - Start litebike on 8888"
    echo
    echo "  # On Mac/Client:"
    echo "  $0 client                  - Auto-configure for \$TERMUX_HOST"
    echo "  $0 forward                 - SSH tunnel localhost:8888 -> remote:8888"
    echo "  $0 test                    - Test connection"
    echo "  $0 stop                    - Clear all settings"
    echo
    echo -e "${YELLOW}Environment:${NC}"
    echo "  TERMUX_HOST=${TERMUX_HOST} (auto-detected)"
    echo "  TERMUX_USER=${SSH_USER}"
    echo "  TERMUX_PORT=${SSH_PORT}"
    echo
    echo -e "${YELLOW}Features:${NC}"
    echo "  • Universal port 8888 for all protocols (HTTP/SOCKS5/TLS/DoH)"
    echo "  • Auto-detection of TERMUX_HOST from routing table"
    echo "  • SSH localhost forwarding for easy access"
    echo "  • System proxy configuration (macOS)"
    echo "  • Git proxy configuration"
    echo "  • PAC/WPAD auto-configuration support"
    echo "  • Bonjour/mDNS service advertisement"
    echo "  • UPnP port mapping for router traversal"
    echo
    echo "ssh -L 8888:${TERMUX_HOST}:8888 ${SSH_USER}@${TERMUX_HOST} -p ${SSH_PORT}"
}

# Main execution
case "${1:-help}" in
    "server"|"start")
        start_server "${2:-default}"
        ;;
    "client")
        start_client "${2:-$TERMUX_HOST}"
        ;;
    "forward")
        ssh_forward "${2:-$TERMUX_HOST}" "${3:-$UNIVERSAL_PORT}" "${4:-$UNIVERSAL_PORT}"
        ;;
    "test")
        test_connection "${2:-$TERMUX_HOST}"
        ;;
    "status")
        show_status
        ;;
    "stop")
        stop_all
        ;;
    "help"|"--help"|"-h"|*)
        show_help
        ;;
esac